---
title: js-57-å‰ç«¯å¤§æ•°æ®é‡æ¸²æŸ“
date: 2021-06-29 13:06:28
top: true
tags:
categories:
- JavaScript
---
### ä¸€ã€æ¦‚è¦

åœ¨å¼€å§‹ä»£ç ä¹‹å‰æˆ‘ä»¬å…ˆåšå¥½åŸºç¡€å‡†å¤‡, ç¬”è€…å…ˆç”¨nodejsæ­å»ºä¸€ä¸ªæ•°æ®æœåŠ¡å™¨, æä¾›åŸºæœ¬çš„æ•°æ®è¯·æ±‚,æ ¸å¿ƒä»£ç å¦‚ä¸‹:

```js
app.use(async (ctx, next) => {
  if(ctx.url === '/api/getMock') {
    let list = []
    
    // ç”ŸæˆæŒ‡å®šä¸ªæ•°çš„éšæœºå­—ç¬¦ä¸²
    function genrateRandomWords(n) {
      let words = 'abcdefghijklmnopqrstuvwxyzä½ æ˜¯å¥½çš„å—¯æ°”çŸ­å‰ç«¯åç«¯è®¾è®¡äº§å“ç½‘ä½†è€ƒè™‘åˆ°ä»˜æ¬¾å•¦åˆ†æ‰‹å¿«ä¹çš„åˆ†ç±»å¼€å‘å•†çš„æå¼€å¤å°ç–†å¤§åå¸ˆå¾·å¸ˆé£å‰æ—çœé™„è¿‘',
          len = words.length,
          ret = ''
      for(let i=0; i< n; i++) {
        ret += words[Math.floor(Math.random() * len)]
      }
      return ret
    }

    // ç”Ÿæˆ10ä¸‡æ¡æ•°æ®çš„list
    for(let i = 0; i< 100000; i++) {
      list.push({
        name: `xu_0${i}`,
        title: genrateRandomWords(12),
        text: `æˆ‘æ˜¯ç¬¬${i}é¡¹ç›®, èµ¶å¿«ğŸŒ€å§~~`,
        tid: `xx_${i}`
      })
    }

    ctx.body = {
      state: 200,
      data: list
    }
  }
  await next()
})
```

ä»¥ä¸Šæ˜¯é‡‡ç”¨koaå®ç°çš„åŸºæœ¬çš„mockæ•°æ®æœåŠ¡å™¨, è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ¨¡æ‹ŸçœŸå®çš„åç«¯ç¯å¢ƒæ¥å¼€å§‹æˆ‘ä»¬çš„å‰ç«¯å¼€å‘å•¦(å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥åœ¨å‰ç«¯æ‰‹åŠ¨ç”Ÿæˆ10ä¸‡æ¡æ•°æ®). å…¶ä¸­genrateRandomWordsæ–¹æ³•ç”¨æ¥ç”ŸæˆæŒ‡å®šä¸ªæ•°çš„å­—ç¬¦ä¸²,è¿™åœ¨mockæ•°æ®æŠ€æœ¯ä¸­åº”ç”¨å¾ˆå¤šã€‚

æ¥ä¸‹æ¥çš„å‰ç«¯ä»£ç ç»Ÿä¸€é‡‡ç”¨reactæ¥å®ç°(vueåŒç†)

### äºŒã€åˆçº§æ–¹æ¡ˆ

ç›´æ¥ä»åç«¯è¯·æ±‚æ•°æ®, æ¸²æŸ“åˆ°é¡µé¢çš„ç¡¬ç¼–ç æ–¹æ¡ˆ,æ€è·¯å¦‚ä¸‹:

![moreData001.jpg](http://alivnram-test.oss-cn-beijing.aliyuncs.com/alivnblog/moreData001.jpg)

ä»£ç å¯èƒ½æ˜¯è¿™æ ·çš„:

1.è¯·æ±‚åç«¯æ•°æ®

```js
fetch(`${SERVER_URL}/api/getMock`).then(res => res.json()).then(res => {
  if(res.state) {
    data = res.data
    setList(data)
  }
})
```

2.æ¸²æŸ“é¡µé¢

```html
{
    list.map((item, i) => {
      return <div className={styles.item} key={item.tid}>
        <div className={styles.tit}>{item.title} <span className={styles.label}>{item.name}</span></div>
        <div>{item.text}</div>
      </div>
    })
}
```

3.æœç´¢æ•°æ®

```js
const handleSearch = (v) => {
    let searchData = data.filter((item, i) => {
      return item.title.indexOf(v) > -1
     })
     setList(searchData)
  }
```

è¿™æ ·åšæœ¬è´¨ä¸Šæ˜¯å¯ä»¥å®ç°åŸºæœ¬çš„éœ€æ±‚,ä½†æ˜¯æœ‰æ˜æ˜¾çš„ç¼ºç‚¹,é‚£å°±æ˜¯æ•°æ®ä¸€æ¬¡æ€§æ¸²æŸ“åˆ°é¡µé¢ä¸­, æ•°æ®é‡åºå¤§å°†å¯¼è‡´é¡µé¢æ€§èƒ½æå…·é™ä½, é€ æˆé¡µé¢å¡é¡¿.

### ä¸‰ã€ä¸­çº§æ–¹æ¡ˆ

ä½œä¸ºä¸€åæœ‰ä¸€å®šç»éªŒçš„å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ,ä¸€å®šå¯¹é¡µé¢æ€§èƒ½æœ‰æ‰€äº†è§£, æ‰€ä»¥ä¸€å®šä¼šç†Ÿæ‚‰é˜²æŠ–å‡½æ•°å’ŒèŠ‚æµå‡½æ•°, å¹¶ä½¿ç”¨è¿‡è¯¸å¦‚æ‡’åŠ è½½å’Œåˆ†é¡µè¿™æ ·çš„æ–¹æ¡ˆ, æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ä¸­çº§æ–¹æ¡ˆ:

![moreData002.jpg](http://alivnram-test.oss-cn-beijing.aliyuncs.com/alivnblog/moreData002.jpg)

é€šè¿‡è¿™ä¸ªè¿‡ç¨‹çš„ä¼˜åŒ–, ä»£ç å·²ç»åŸºæœ¬å¯ç”¨äº†, ä¸‹é¢æ¥ä»‹ç»å…·ä½“å®ç°æ–¹æ¡ˆ:

1.æ‡’åŠ è½½+åˆ†é¡µæ–¹æ¡ˆ æ‡’åŠ è½½çš„å®ç°ä¸»è¦æ˜¯é€šè¿‡ç›‘å¬çª—å£çš„æ»šåŠ¨, å½“æŸä¸€ä¸ªå ä½å…ƒç´ å¯è§ä¹‹åå»åŠ è½½ä¸‹ä¸€ä¸ªæ•°æ®,åŸç†å¦‚ä¸‹:

![moreData003.jpg](http://alivnram-test.oss-cn-beijing.aliyuncs.com/alivnblog/moreData003.jpg)

è¿™é‡Œæˆ‘ä»¬é€šè¿‡ç›‘å¬windowçš„scrolläº‹ä»¶ä»¥åŠå¯¹pollå…ƒç´ ä½¿ç”¨getBoundingClientRectæ¥è·å–pollå…ƒç´ ç›¸å¯¹äºå¯è§†çª—å£çš„è·ç¦», ä»è€Œè‡ªå·±å®ç°ä¸€ä¸ªæ‡’åŠ è½½æ–¹æ¡ˆ.

åœ¨æ»šåŠ¨çš„è¿‡ç¨‹æ±‡æ€»æˆ‘ä»¬è¿˜éœ€è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜å°±æ˜¯å½“ç”¨æˆ·å¾€å›æ»šåŠ¨æ—¶, å®é™…ä¸Šæ˜¯ä¸éœ€è¦åšä»»ä½•å¤„ç†çš„,æ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ ä¸€ä¸ªå•å‘é”, å…·ä½“ä»£ç å¦‚ä¸‹:

```js
function scrollAndLoading() {
    if(window.scrollY > prevY) {  // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å‘ä¸‹æ»šåŠ¨
      prevY = window.scrollY
      if(poll.current.getBoundingClientRect().top <= window.innerHeight) {
        // è¯·æ±‚ä¸‹ä¸€é¡µæ•°æ®
      }
    }
}

useEffect(() => {
    // something code
    const getData = debounce(scrollAndLoading, 300)
    window.addEventListener('scroll', getData, false)
    return () => {
      window.removeEventListener('scroll', getData, false)
    }
  }, [])
```

å…¶ä¸­prevYå­˜å‚¨çš„æ˜¯çª—å£ä¸Šä¸€æ¬¡æ»šåŠ¨çš„è·ç¦», åªæœ‰åœ¨å‘ä¸‹æ»šåŠ¨å¹¶ä¸”æ»šåŠ¨é«˜åº¦å¤§äºä¸Šä¸€æ¬¡æ—¶æ‰æ›´æ–°å…¶å€¼.

è‡³äºåˆ†é¡µçš„é€»è¾‘, åŸç”Ÿjavascriptå®ç°åˆ†é¡µä¹Ÿå¾ˆç®€å•, æˆ‘ä»¬é€šè¿‡å®šä¹‰å‡ ä¸ªç»´åº¦:

- curPageå½“å‰çš„é¡µæ•°
- pageSize æ¯ä¸€é¡µå±•ç¤ºçš„æ•°é‡
- data ä¼ å…¥çš„æ•°æ®é‡

æœ‰äº†è¿™å‡ ä¸ªæ¡ä»¶,æˆ‘ä»¬çš„åŸºæœ¬èƒ½åˆ†é¡µåŠŸèƒ½å°±å¯ä»¥å®Œæˆäº†. å‰ç«¯åˆ†é¡µçš„æ ¸å¿ƒä»£ç å¦‚ä¸‹:

```js
let data = [];
let curPage = 1;
let pageSize = 16;
let prevY = 0;

// other code...

function scrollAndLoading() {
    if(window.scrollY > prevY) {  // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å‘ä¸‹æ»šåŠ¨
      prevY = window.scrollY
      if(poll.current.getBoundingClientRect().top <= window.innerHeight) {
        curPage++
        setList(searchData.slice(0, pageSize * curPage))
      }
    }
}
```

2.é˜²æŠ–å‡½æ•°å®ç° é˜²æŠ–å‡½æ•°å› ä¸ºæ¯”è¾ƒç®€å•, è¿™é‡Œç›´æ¥ä¸Šä¸€ä¸ªç®€å•çš„é˜²æŠ–å‡½æ•°ä»£ç :

```js
function debounce(fn, time) {
    return function(args) {
      let that = this
      clearTimeout(fn.tid)
      fn.tid = setTimeout(() => {
        fn.call(that, args)
      }, time);
    }
  }
```

3.æœç´¢å®ç° æœç´¢åŠŸèƒ½ä»£ç å¦‚ä¸‹:

```js
const handleSearch = (v) => {
     curPage = 1;
     prevY = 0;
     searchData = data.filter((item, i) => {
        // é‡‡ç”¨æ­£åˆ™æ¥åšåŒ¹é…, åæœŸæ”¯æŒå‰ç«¯æ¨¡ç³Šæœç´¢
       let reg = new RegExp(v, 'gi')
       return reg.test(item.title)
     })
     setList(searchData.slice(0, pageSize * curPage))
}
```

éœ€è¦ç»“åˆåˆ†é¡µæ¥å®ç°, æ‰€ä»¥è¿™é‡Œä¸ºäº†ä¸å½±å“æºæ•°æ®, æˆ‘ä»¬é‡‡ç”¨ä¸´æ—¶æ•°æ®searchDataæ¥å­˜å‚¨. æ•ˆæœå¦‚ä¸‹:

![moreData004.jpg](http://alivnram-test.oss-cn-beijing.aliyuncs.com/alivnblog/moreData004.jpg)

æœç´¢å:

![moreData005.jpg](http://alivnram-test.oss-cn-beijing.aliyuncs.com/alivnblog/moreData005.jpg)

æ— è®ºæ˜¯æœç´¢å‰è¿˜æ˜¯æœç´¢å, éƒ½åˆ©ç”¨äº†æ‡’åŠ è½½, æ‰€ä»¥å†ä¹Ÿä¸ç”¨æ‹…å¿ƒæ•°æ®é‡å¤§å¸¦æ¥çš„æ€§èƒ½ç“¶é¢ˆäº†~

### å››ã€é«˜çº§æ–¹æ¡ˆ

ä½œä¸ºä¸€åä¹…ç»æˆ˜åœºçš„ç¨‹åºå‘˜, æˆ‘ä»¬åº”è¯¥è€ƒè™‘æ›´ä¼˜é›…çš„å®ç°æ–¹å¼,æ¯”å¦‚ç»„ä»¶åŒ–, ç®—æ³•ä¼˜åŒ–, å¤šçº¿ç¨‹è¿™ç±»é—®é¢˜, å°±æ¯”å¦‚æˆ‘ä»¬é—®é¢˜ä¸­çš„å¤§æ•°æ®æ¸²æŸ“, æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨è™šæ‹Ÿé•¿åˆ—è¡¨æ¥æ›´ä¼˜é›…ç®€æ´çš„æ¥è§£å†³æˆ‘ä»¬çš„éœ€æ±‚. è‡³äºè™šæ‹Ÿé•¿åˆ—è¡¨çš„å®ç°ç¬”è€…åœ¨å¼€å¤´å·²ç»ç‚¹è¿‡,è¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†, å¯¹äºæ›´å¤§é‡çš„æ•°æ®,æ¯”å¦‚100ä¸‡(è™½ç„¶å®é™…å¼€å‘ä¸­ä¸ä¼šé‡åˆ°è¿™ä¹ˆæ— è„‘çš„åœºæ™¯),æˆ‘ä»¬åˆè¯¥æ€ä¹ˆå¤„ç†å‘¢?

ç¬¬ä¸€ä¸ªç‚¹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨jsç¼“å†²å™¨æ¥åˆ†ç‰‡å¤„ç†100ä¸‡æ¡æ•°æ®, æ€è·¯ä»£ç å¦‚ä¸‹:

```js
function multistep(steps,args,callback){
    var tasks = steps.concat();

    setTimeout(function(){
        var task = tasks.shift();
        task.apply(null, args || []);   //è°ƒç”¨Applyå‚æ•°å¿…é¡»æ˜¯æ•°ç»„

        if(tasks.length > 0){
            setTimeout(arguments.callee, 25);
        }else{
            callback();
        }
    },25);
}
```

è¿™æ ·å°±èƒ½æ¯”è¾ƒå¤§é‡è®¡ç®—å¯¼è‡´çš„jsè¿›ç¨‹é˜»å¡é—®é¢˜äº†ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡web workeræ¥å°†éœ€è¦åœ¨å‰ç«¯è¿›è¡Œå¤§é‡è®¡ç®—çš„é€»è¾‘ç§»å…¥è¿›å», ä¿è¯jsä¸»è¿›ç¨‹çš„å¿«é€Ÿå“åº”, è®©web workerçº¿ç¨‹åœ¨åå°è®¡ç®—, è®¡ç®—å®Œæˆåå†é€šè¿‡web workerçš„é€šä¿¡æœºåˆ¶æ¥é€šçŸ¥ä¸»è¿›ç¨‹, æ¯”å¦‚æ¨¡ç³Šæœç´¢ç­‰, æˆ‘ä»¬è¿˜å¯ä»¥å¯¹æœç´¢ç®—æ³•è¿›ä¸€æ­¥ä¼˜åŒ–,æ¯”å¦‚äºŒåˆ†æ³•ç­‰,æ‰€ä»¥è¿™äº›éƒ½æ˜¯é«˜çº§å·¥ç¨‹å¸ˆè¯¥è€ƒè™‘çš„é—®é¢˜. ä½†æ˜¯ä¸€å®šè¦åˆ†æ¸…åœºæ™¯, å¯»æ‰¾å‡ºæ€§ä»·æ¯”æ›´é«˜çš„æ–¹æ¡ˆ.

