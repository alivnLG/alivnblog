---
title: 微信扫码登录实现原理
date: 2020-10-10 11:05:42
top: true
tags:
- 扫码
- appId
- OAuth2.0
- uuId
- code
categories:
- 微信开发
---
#### 1.生成二维码
首先，用户打开网站的登录首页的时候，浏览器就会向对应网页服务器发送获取登录二维码的请求，服务器收到请求后，会随机生成一个 uuid，将这个 uuid 作为key值存入redis服务器，同时设置一个过期时间，一旦过期后，用户登录二维码需要进行刷新重新获取。
<!--more-->
同时，将这个key值和公司的验证字符串合在一起，通过二维码生成接口，生成一个二维码的图片。然后，将二维码图片和 uuid 一起返回给用户浏览器。

例如，对于某个登录的网页（我打开的是力扣的微信登录地址），我们习惯性地打开了浏览器的开发者工具，我发现当我在登录页面停滞一小会（大概30秒样子），请求链接会不断发生变化，如下图所示：

![wechat001](http://alivnram-test.oss-cn-beijing.aliyuncs.com/alivnblog/wechat001.jpg)

- 其中就有一个字段 uuid，伴随着链接的更新而自增变化。这就很好解释了上文，服务器端会通过这个 uuid 调用相关接口来返回给浏览器一个二维码。
- 当用户打开网站后，网站后台根据微信 OAuth2.0 协议向微信开发平台请求授权登录，并传递事先在微信开发平台中审核通过的 AppID 和 AppSecrect 等参数
- 微信开发平台对AppID等参数进行验证，并向网站后台返回二维码

#### 2.识别扫码用户
当用户拿出手机扫描二维码，就可以得到一个验证信息和一个 uuid。由于手机端已经进行过了登录，在访问手机端的服务器的时候，参数中都会携带一个用户的token，手机端服务器可以从中解析到用户的 userId（这里从token中取值而不是手机端直接传userid是为了安全，直接传userid可能会被截获和修改，token是加密的，被修改的风险会小很多）。

手机端将解析到的数据与微信账号绑定，向微信开发平台发送登录验证请求，微信开发平台验证绑定数据，调用网站后台的回调接口，发送授权临时票据 code ，如果授权成功，返回一个确认信息给手机端。

手机端收到返回后，将登录确认框显示给用户（防止用户误操作，同时使登录更加人性化）。用户确认是进行的登录操作后，手机再次发送请求。服务器拿到 uuId 和 userId 后，将用户的userid作为value值存入redis中以uuid作为key的键值对中。

- 网站后台接收到code，表明微信开发平台同意数据请求
- 网站后台根据code参数，再加上AppID和AppSecret请求微信开发平台换取 access_token
- 微信开发平台验证参数，并返回 access_token
- 网站后台收到 access_token 后即可进行参数分析获得用户账号数据

- AppID：应用唯一标识，在微信开放平台提交应用审核通过后获得
- AppSecret：应用密钥，在微信开放平台提交应用审核通过后获得
- code：授权临时票据，第三方通过code进行获取access_token的时候需要用到，code的超时时间为10分钟，一个code只能成功换取一次access_token 即失效。code的临时性和一次性保障了微信授权登录的安全性。
- access_token：用户授权第三方应用发起接口调用的凭证

整个过程从网站后台向微信开发平台请求授权登录开始，最终目的是为了获得 access_token。

在获得了 access_token 后就可以解析用户的一些基本信息，包括头像、用户名、性别、城市等。这样一来，整个微信扫描登录的过程就完成了。

#### 3.实验流程图
![wechat002](http://alivnram-test.oss-cn-beijing.aliyuncs.com/alivnblog/wechat002.jpg)